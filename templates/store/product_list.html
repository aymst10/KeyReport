{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Components - Key Reports Analytics{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Filters -->
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filters
                </h5>
            </div>
            <div class="card-body">
                <form method="get" id="filter-form">
                    <!-- Search -->
                    <div class="mb-3">
                        <label for="q" class="form-label">Search</label>
                        <input type="text" class="form-control" id="q" name="q" value="{{ query }}" placeholder="Search products...">
                    </div>

                    <!-- Categories -->
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.slug }}" {% if category_slug == category.slug %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Price Range -->
                    <div class="mb-3">
                        <label class="form-label">Price Range (MAD)</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control" name="min_price" value="{{ min_price|default:'' }}" placeholder="Min" step="0.01" min="0">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" name="max_price" value="{{ max_price|default:'' }}" placeholder="Max" step="0.01" min="0">
                            </div>
                        </div>
                        <!-- Quick Price Filters -->
                        <div class="mt-2">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPriceRange(0, 500)">Under 500</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPriceRange(500, 1500)">500-1500</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPriceRange(1500, 9999)">1500+</button>
                            </div>
                        </div>
                    </div>

                    <!-- Brand Filter -->
                    <div class="mb-3">
                        <label for="brand" class="form-label">Brand</label>
                        <select class="form-select" id="brand" name="brand">
                            <option value="">All Brands</option>
                            <option value="Samsung" {% if brand == 'Samsung' %}selected{% endif %}>Samsung</option>
                            <option value="Intel" {% if brand == 'Intel' %}selected{% endif %}>Intel</option>
                            <option value="AMD" {% if brand == 'AMD' %}selected{% endif %}>AMD</option>
                            <option value="NVIDIA" {% if brand == 'NVIDIA' %}selected{% endif %}>NVIDIA</option>
                            <option value="LG" {% if brand == 'LG' %}selected{% endif %}>LG</option>
                            <option value="Dell" {% if brand == 'Dell' %}selected{% endif %}>Dell</option>
                            <option value="ASUS" {% if brand == 'ASUS' %}selected{% endif %}>ASUS</option>
                            <option value="MSI" {% if brand == 'MSI' %}selected{% endif %}>MSI</option>
                            <option value="HP" {% if brand == 'HP' %}selected{% endif %}>HP</option>
                            <option value="Canon" {% if brand == 'Canon' %}selected{% endif %}>Canon</option>
                            <option value="Corsair" {% if brand == 'Corsair' %}selected{% endif %}>Corsair</option>
                            <option value="Western Digital" {% if brand == 'Western Digital' %}selected{% endif %}>Western Digital</option>
                            <option value="Seagate" {% if brand == 'Seagate' %}selected{% endif %}>Seagate</option>
                            <option value="Logitech" {% if brand == 'Logitech' %}selected{% endif %}>Logitech</option>
                            <option value="Microsoft" {% if brand == 'Microsoft' %}selected{% endif %}>Microsoft</option>
                        </select>
                    </div>

                    <!-- Stock Status -->
                    <div class="mb-3">
                        <label class="form-label">Stock Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="in_stock" id="in_stock" {% if in_stock %}checked{% endif %}>
                            <label class="form-check-label" for="in_stock">
                                In Stock Only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="on_sale" id="on_sale" {% if on_sale %}checked{% endif %}>
                            <label class="form-check-label" for="on_sale">
                                On Sale Only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="featured" id="featured" {% if featured %}checked{% endif %}>
                            <label class="form-check-label" for="featured">
                                Featured Only
                            </label>
                        </div>
                    </div>

                    <!-- Sort By -->
                    <div class="mb-3">
                        <label for="sort" class="form-label">Sort By</label>
                        <select class="form-select" id="sort" name="sort">
                            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest First</option>
                            <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Oldest First</option>
                            <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                            <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                            <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                            <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
                        </select>
                    </div>

                    <!-- Apply Filters -->
                    <button type="submit" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-search me-2"></i>Apply Filters
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearAllFilters()">
                        <i class="fas fa-times me-2"></i>Clear All
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="col-lg-9">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Analytics Components
                </h1>
                {% if products %}
                    <p class="text-muted mb-0">
                        Showing {{ products.start_index }}-{{ products.end_index }} of {{ products.paginator.count }} components
                    </p>
                {% endif %}
            </div>
            <div class="d-flex align-items-center">
                <div class="btn-group me-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="grid-view">
                        <i class="fas fa-th"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="list-view">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Products -->
        {% if products %}
            <div class="row" id="products-container">
                {% for product in products %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 product-card">
                        <!-- Product Image -->
                        <div class="position-relative">
                            {% if product.main_image %}
                                <img src="{{ product.main_image.url }}" class="card-img-top" alt="{{ product.name }}" style="height: 200px; object-fit: cover;">
                            {% else %}
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                            
                            <!-- Badges -->
                            <div class="position-absolute top-0 start-0 m-2">
                                {% if product.is_featured %}
                                    <span class="badge bg-warning">Featured</span>
                                {% endif %}
                                {% if product.sale_price %}
                                    <span class="badge bg-danger">Sale</span>
                                {% endif %}
                                {% if not product.is_in_stock %}
                                    <span class="badge bg-secondary">Out of Stock</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Product Info -->
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">
                                {% if product.slug %}
                                    <a href="{% url 'store:product_detail' product.slug %}" class="text-decoration-none">
                                        {{ product.name|truncatechars:50 }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">{{ product.name|truncatechars:50 }}</span>
                                {% endif %}
                            </h6>
                            
                            <p class="card-text text-muted small">
                                {{ product.short_description|default:product.description|truncatechars:80 }}
                            </p>
                            
                            <!-- Star Rating -->
                            {% if product.total_reviews > 0 %}
                                <div class="mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= product.average_rating %}
                                                    <i class="fas fa-star text-warning" style="font-size: 0.8rem;"></i>
                                                {% else %}
                                                    <i class="far fa-star text-muted" style="font-size: 0.8rem;"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">({{ product.total_reviews }})</small>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Price -->
                            <div class="mb-2">
                                {% if product.sale_price %}
                                    <span class="text-danger fw-bold">{{ product.sale_price }} MAD</span>
                                    <small class="text-muted text-decoration-line-through">{{ product.price }} MAD</small>
                                {% else %}
                                    <span class="fw-bold">{{ product.price }} MAD</span>
                                {% endif %}
                            </div>

                            <!-- Stock Status -->
                            <div class="mb-3">
                                {% if product.is_in_stock %}
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>In Stock ({{ product.stock_quantity }})
                                    </small>
                                {% else %}
                                    <small class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>Out of Stock
                                    </small>
                                {% endif %}
                            </div>

                            <!-- Actions -->
                            <div class="mt-auto">
                                <div class="d-grid gap-2">
                                    <a href="{% url 'store:product_detail' product.slug %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a>
                                    {% if product.is_in_stock %}
                                        <form method="post" action="{% url 'store:add_to_cart' product.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="quantity" value="1">
                                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                                <i class="fas fa-cart-plus me-1"></i>Add to Cart
                                            </button>
                                        </form>
                                    {% endif %}
                                    {% if user.is_authenticated %}
                                        <button type="button" class="btn btn-outline-secondary btn-sm wishlist-btn" 
                                                data-product-id="{{ product.id }}" 
                                                data-product-name="{{ product.name }}">
                                            <i class="fas fa-heart me-1"></i>
                                            <span class="wishlist-text">Add to Wishlist</span>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if products.has_other_pages %}
                <nav aria-label="Products pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if products.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category_slug %}&category={{ category_slug }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in products.paginator.page_range %}
                            {% if products.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if category_slug %}&category={{ category_slug }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if products.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if category_slug %}&category={{ category_slug }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <!-- No Products Found -->
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No components found</h4>
                <p class="text-muted">
                    {% if query or category_slug or min_price or max_price %}
                        No components match your current filters. Try adjusting your search criteria.
                    {% else %}
                        No components are currently available.
                    {% endif %}
                </p>
                {% if query or category_slug or min_price or max_price %}
                    <a href="{% url 'store:product_list' %}" class="btn btn-primary">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Grid/List View Styles */
#products-container.list-view {
    display: block;
}

#products-container.list-view .col-md-6,
#products-container.list-view .col-lg-4 {
    width: 100%;
    max-width: 100%;
    flex: 0 0 100%;
}

#products-container.list-view .product-card {
    display: flex;
    flex-direction: row;
    height: auto;
    margin-bottom: 1rem;
}

#products-container.list-view .product-card .position-relative {
    width: 200px;
    flex-shrink: 0;
}

#products-container.list-view .product-card .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#products-container.list-view .product-card .card-img-top {
    height: 150px !important;
    width: 100%;
    object-fit: cover;
}

#products-container.list-view .product-card .actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

#products-container.list-view .product-card .actions .btn {
    flex: 1;
    max-width: 150px;
}

/* Button States */
.btn-group .btn.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.btn-group .btn:not(.active) {
    background-color: transparent;
    border-color: #0d6efd;
    color: #0d6efd;
}

.btn-group .btn:hover:not(.active) {
    background-color: #e7f1ff;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #products-container.list-view .product-card {
        flex-direction: column;
    }
    
    #products-container.list-view .product-card .position-relative {
        width: 100%;
    }
    
    #products-container.list-view .product-card .card-img-top {
        height: 200px !important;
    }
    
    /* Mobile layout improvements */
    .col-lg-3 {
        margin-bottom: 20px;
    }
    
    .card {
        margin-bottom: 16px;
    }
    
    .card-body {
        padding: 16px;
    }
    
    .btn-group {
        margin-bottom: 16px;
    }
    
    .btn-group .btn {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    .form-control, .form-select {
        font-size: 0.9rem;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .card-img-top {
        height: 180px !important;
    }
    
    .card-title {
        font-size: 0.95rem;
    }
    
    .card-text {
        font-size: 0.85rem;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 4px 6px;
    }
    
    .pagination {
        margin-top: 20px;
    }
    
    .pagination .page-link {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .col-lg-3 {
        margin-bottom: 16px;
    }
    
    .card-body {
        padding: 12px;
    }
    
    .btn-group .btn {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    
    .form-control, .form-select {
        font-size: 0.85rem;
        padding: 8px 12px;
    }
    
    .btn-sm {
        padding: 5px 10px;
        font-size: 0.75rem;
    }
    
    .card-img-top {
        height: 160px !important;
    }
    
    .card-title {
        font-size: 0.9rem;
    }
    
    .card-text {
        font-size: 0.8rem;
    }
    
    .badge {
        font-size: 0.65rem;
        padding: 3px 5px;
    }
    
    .pagination .page-link {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    
    .h3 {
        font-size: 1.25rem;
    }
    
    .text-muted {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Grid/List view toggle
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    const productsContainer = document.getElementById('products-container');

    gridView.addEventListener('click', function() {
        gridView.classList.add('active');
        listView.classList.remove('active');
        productsContainer.classList.remove('list-view');
        // Save preference to localStorage
        localStorage.setItem('productViewMode', 'grid');
    });

    listView.addEventListener('click', function() {
        listView.classList.add('active');
        gridView.classList.remove('active');
        productsContainer.classList.add('list-view');
        // Save preference to localStorage
        localStorage.setItem('productViewMode', 'list');
    });

    // Restore view preference on page load
    const savedViewMode = localStorage.getItem('productViewMode');
    if (savedViewMode === 'list') {
        listView.click();
    }

    // Auto-submit form on select change
    const filterForm = document.getElementById('filter-form');
    const autoSubmitElements = filterForm.querySelectorAll('select, input[type="number"]');
    
    autoSubmitElements.forEach(element => {
        element.addEventListener('change', function() {
            filterForm.submit();
        });
    });

    // Enhanced search functionality
    const searchInput = document.getElementById('q');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length >= 2 || this.value.length === 0) {
                filterForm.submit();
            }
        }, 500); // Wait 500ms after user stops typing
    });

    // Checkbox change handlers
    const checkboxes = filterForm.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            filterForm.submit();
        });
    });

    // Search suggestions (basic implementation)
    const searchSuggestions = [
        'Samsung', 'Intel', 'AMD', 'NVIDIA', 'Monitor', 'Processor', 'SSD', 'Graphics Card',
        'Printer', 'Keyboard', 'Mouse', 'Motherboard', 'RAM', 'Hard Drive'
    ];
    
    searchInput.addEventListener('focus', function() {
        if (this.value.length >= 2) {
            showSuggestions(this.value);
        }
    });
});

// Global functions
function setPriceRange(min, max) {
    document.querySelector('input[name="min_price"]').value = min;
    document.querySelector('input[name="max_price"]').value = max;
    document.getElementById('filter-form').submit();
}

function showSuggestions(query) {
    // Basic suggestion implementation
    const suggestions = searchSuggestions.filter(item => 
        item.toLowerCase().includes(query.toLowerCase())
    );
    
    if (suggestions.length > 0) {
        console.log('Suggestions:', suggestions);
        // You can implement a dropdown here
    }
}

function clearAllFilters() {
    document.getElementById('filter-form').reset();
    document.getElementById('filter-form').submit();
}

// Wishlist functionality
document.addEventListener('DOMContentLoaded', function() {
    const wishlistButtons = document.querySelectorAll('.wishlist-btn');
    
    wishlistButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            const icon = this.querySelector('i');
            const text = this.querySelector('.wishlist-text');
            
            // Toggle button state
            this.disabled = true;
            
            // Make AJAX request to toggle wishlist
            fetch('/wishlist/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    product_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.added) {
                        icon.className = 'fas fa-heart me-1 text-danger';
                        text.textContent = 'In Wishlist';
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-outline-danger');
                        
                        // Show success message
                        showNotification(`${productName} added to wishlist!`, 'success');
                    } else {
                        icon.className = 'fas fa-heart me-1';
                        text.textContent = 'Add to Wishlist';
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-outline-secondary');
                        
                        // Show success message
                        showNotification(`${productName} removed from wishlist!`, 'info');
                    }
                } else {
                    showNotification('Please log in to use wishlist', 'warning');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred. Please try again.', 'danger');
            })
            .finally(() => {
                this.disabled = false;
            });
        });
    });
});

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
